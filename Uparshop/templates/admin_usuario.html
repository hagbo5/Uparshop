{% extends 'base_admin.html' %}
{% block title %}Gestión de Usuarios - Panel Admin{% endblock %}
{% block content %}
<div class="admin-users">
    <div class="admin-users-header">
        <span class="admin-users-title"><i class="fas fa-users"></i> Gestión de Usuarios</span>
        <form class="admin-users-search" method="get" autocomplete="off" style="position:relative;">
            <input id="q-input" type="text" name="q" placeholder="Buscar usuario..." value="{{ q if q is defined else '' }}" autocomplete="off" aria-autocomplete="list" aria-haspopup="listbox" aria-expanded="false" aria-owns="autocomplete-box">
            <div id="autocomplete-box" class="autocomplete-box" role="listbox" aria-label="Sugerencias de usuario" style="display:none; position:absolute; top:42px; left:0; right:0; background:#121b24; border:1px solid #25313b; border-radius:8px; max-height:260px; overflow-y:auto; z-index:40; box-shadow:0 6px 18px rgba(0,0,0,0.35);">
                <!-- suggestions injected here -->
            </div>
            <button type="submit"><i class="fas fa-search"></i> Buscar</button>
        </form>
</table>
    <script>
    (function(){
        const input = document.getElementById('q-input');
        const box = document.getElementById('autocomplete-box');
        let timer = null; let lastQuery=''; let activeIndex = -1;
        const HIGHLIGHT_BG = 'rgba(255,255,255,0.08)';
        const NORMAL_BG = 'transparent';
        function clearBox(){ box.innerHTML=''; box.style.display='none'; input.setAttribute('aria-expanded','false'); activeIndex=-1; }
        function showBox(){ if(box.children.length){ box.style.display='block'; input.setAttribute('aria-expanded','true'); } }
        function highlightMatch(text, query){
            const q = query.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
            const re = new RegExp(q,'ig');
            return text.replace(re, m=>`<mark style="background:#ffc40033;color:#ffd36a;border-radius:3px;">${m}</mark>`);
        }
        function setActive(i){
            const items = box.querySelectorAll('[role="option"]');
            items.forEach((el,idx)=>{ el.style.background = idx===i? HIGHLIGHT_BG : NORMAL_BG; });
            activeIndex = i;
        }
        function applySelection(){
            if(activeIndex<0) return; const items = box.querySelectorAll('[role="option"]');
            const el = items[activeIndex]; if(!el) return; input.value = el.getAttribute('data-name'); clearBox(); input.focus(); }
        function fetchData(q){
            fetch(`/admin/usuarios/autocomplete?q=${encodeURIComponent(q)}`)
                .then(r=>r.json())
                .then(items=>{
                    box.innerHTML=''; activeIndex=-1;
                    if(!items.length){ clearBox(); return; }
                    items.forEach((u,idx)=>{
                        const item = document.createElement('div');
                        item.className='ac-item';
                        item.setAttribute('role','option');
                        item.setAttribute('data-name', u.nombre);
                        item.style.padding='8px 12px';
                        item.style.cursor='pointer';
                        item.style.display='flex';
                        item.style.flexDirection='column';
                        item.style.gap='2px';
                        item.innerHTML = `<span style=\"font-weight:600; color:#f1f5f9;\">${highlightMatch(u.nombre,q)}</span>`+
                                         `<span style=\"font-size:0.75rem; color:#8aa0b5;\">${highlightMatch(u.correo,q)}</span>`;
                        item.addEventListener('mouseenter',()=>{ setActive(idx); });
                        item.addEventListener('mousedown',(ev)=>{ ev.preventDefault(); setActive(idx); applySelection(); });
                        box.appendChild(item);
                    });
                    showBox();
                }).catch(()=> clearBox());
        }
        input.addEventListener('input', function(){
            const v = this.value.trim();
            if(timer) clearTimeout(timer);
            if(!v){ clearBox(); return; }
            if(v === lastQuery) return;
            timer = setTimeout(()=>{ lastQuery=v; fetchData(v); }, 180);
        });
        input.addEventListener('keydown', (e)=>{
            const items = box.querySelectorAll('[role="option"]');
            if(e.key==='ArrowDown') { if(!items.length) return; e.preventDefault(); setActive((activeIndex+1)%items.length); }
            else if(e.key==='ArrowUp'){ if(!items.length) return; e.preventDefault(); setActive((activeIndex-1+items.length)%items.length); }
            else if(e.key==='Enter'){ if(activeIndex>=0 && box.style.display==='block'){ e.preventDefault(); applySelection(); }}
            else if(e.key==='Escape'){ clearBox(); }
        });
        document.addEventListener('click', (e)=>{ if(!box.contains(e.target) && e.target!==input){ clearBox(); }});
    })();
    </script>
    </div>
    <div style="margin-top:10px; color:#333;">
        <strong>Total de coincidencias:</strong> {{ total if total is defined else (usuarios|length) }}
    </div>
    <table class="admin-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Correo</th>
                <th>Rol</th>
                <th>Estado</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for usuario in usuarios %}
            <tr>
                <td>{{ usuario.id_usuario }}</td>
                <td>{{ usuario.nombre_completo }}</td>
                <td>{{ usuario.correo }}</td>
                <td>
                    {% if usuario.id_usuario != 1 %}
                        <form method="post" action="{{ url_for('cambiar_rol_usuario') }}" style="display:inline;">
                            <input type="hidden" name="usuario_id" value="{{ usuario.id_usuario }}">
                            <select name="rol" class="badge" style="color:#fff; background:#6c63ff; border:none; border-radius:12px; padding:4px 12px;" onchange="this.form.submit()">
                                <option value="admin" {% if usuario.rol == 'admin' %}selected{% endif %}>admin</option>
                                <option value="cliente" {% if usuario.rol == 'cliente' %}selected{% endif %}>cliente</option>
                            </select>
                        </form>
                    {% else %}
                        <span class="badge badge-admin">{{ usuario.rol }}</span>
                    {% endif %}
                </td>
                <td>
                    {% if usuario.id_usuario != 1 %}
                        <form method="post" action="{{ url_for('cambiar_estado_usuario') }}" style="display:inline;">
                            <input type="hidden" name="usuario_id" value="{{ usuario.id_usuario }}">
                            <select name="estado" class="badge" style="color:#fff; background:#43b581; border:none; border-radius:12px; padding:4px 12px;" onchange="this.form.submit()">
                                <option value="activo" {% if usuario.estado == 'activo' %}selected{% endif %}>activo</option>
                                <option value="inactivo" {% if usuario.estado == 'inactivo' %}selected{% endif %}>inactivo</option>
                            </select>
                        </form>
                    {% else %}
                        <span class="badge badge-{{ 'activo' if usuario.estado == 'activo' else 'inactivo' }}">{{ usuario.estado }}</span>
                    {% endif %}
                </td>
                <td>
                    {% if usuario.id_usuario != 1 %}
                    <a href="{{ url_for('editar_usuario', usuario_id=usuario.id_usuario) }}" class="action-btn" title="Editar"><i class="fas fa-edit"></i></a>
                    <form method="post" action="{{ url_for('eliminar_usuario') }}" style="display:inline;" onsubmit="return confirm('¿Estás seguro de eliminar este usuario?');">
                        <input type="hidden" name="usuario_id" value="{{ usuario.id_usuario }}">
                        <button type="submit" class="action-btn" title="Eliminar"><i class="fas fa-trash-alt"></i></button>
                    </form>
                    {% else %}
                    <span style="color:var(--border-color);font-size:0.98em;">Protegido</span>
                    {% endif %}
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="6" style="text-align:center; color:var(--accent-color);">
                    {% if q %}
                        No se encontraron usuarios que coincidan con "{{ q }}".
                    {% else %}
                        No hay usuarios registrados.
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
</table>
    {% if pagination %}
    <div class="pagination" style="margin-top:14px; display:flex; gap:8px; align-items:center;">
        {% if pagination.has_prev %}
            <a href="?page={{ pagination.prev_num }}&per_page={{ per_page }}{% if q %}&q={{ q }}{% endif %}">&laquo; Anterior</a>
        {% else %}
            <span style="opacity:0.5">&laquo; Anterior</span>
        {% endif %}
        <span>Página {{ pagination.page }} de {{ pagination.pages }} ({{ total }} resultados)</span>
        {% if pagination.has_next %}
            <a href="?page={{ pagination.next_num }}&per_page={{ per_page }}{% if q %}&q={{ q }}{% endif %}">Siguiente &raquo;</a>
        {% else %}
            <span style="opacity:0.5">Siguiente &raquo;</span>
        {% endif %}
    </div>
    {% endif %}
        </tbody>
    </table>
</div>
{% endblock %}
