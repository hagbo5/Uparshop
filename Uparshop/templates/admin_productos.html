{% extends 'base_admin.html' %}
{% block content %}
<div class="admin-products">
    <div class="admin-products-header">
        <span class="admin-users-title"><i class="fas fa-box"></i> Gestión de Productos</span>
        <div style="display:flex; gap:12px; align-items:center;">
            <form id="admin-filter-form" class="admin-products-search" method="get" style="margin:0; display:flex; gap:8px; align-items:center;">
                <input id="q-input" type="text" name="q" placeholder="Buscar producto..." autocomplete="off" value="{{ q if q is defined else '' }}" list="autocomplete-list">
                <datalist id="autocomplete-list"></datalist>
                <select name="id_categoria">
                    <option value="">Todas las categorías</option>
                    {% for cat in categorias %}
                        <option value="{{ cat.id_categoria }}" {% if id_categoria and id_categoria|int == cat.id_categoria %}selected{% endif %}>{{ cat.nombre }}</option>
                    {% endfor %}
                </select>
                <input type="number" name="min_price" placeholder="Precio min" step="0.01" value="{{ min_price if min_price is defined else '' }}" style="width:110px;">
                <input type="number" name="max_price" placeholder="Precio max" step="0.01" value="{{ max_price if max_price is defined else '' }}" style="width:110px;">
                <button type="submit"><i class="fas fa-search"></i> Buscar</button>
            </form>
            <a href="{{ url_for('registrar_producto') }}" class="btn" style="background:var(--accent-color); color:#fff; padding:10px 20px; border-radius:6px; font-weight:600; text-decoration:none;">
                <i class="fas fa-plus"></i> Registrar producto
            </a>
        </div>
    </div>
    <div style="margin-top:10px; color:#333;">
        <strong>Total de coincidencias:</strong> {{ total if total is defined else (productos|length) }}
    </div>
    <table class="admin-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Thumb</th>
                <th>Nombre</th>
                <th>Precio</th>
                <th>Stock</th>
                <th>Categoría</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for producto in productos %}
            <tr>
                <td>{{ producto.id_producto }}</td>
                <td>
                    {% if producto.imagen_thumb %}
                        <img src="{{ producto.imagen_thumb }}" alt="thumb" style="width:48px; height:48px; object-fit:cover; border-radius:6px;">
                    {% elif producto.imagen_url %}
                        <img src="{{ producto.imagen_url }}" alt="thumb" style="width:48px; height:48px; object-fit:cover; border-radius:6px;">
                    {% else %}
                        <img src="{{ url_for('static', filename='images/product-placeholder.svg') }}" alt="thumb" style="width:48px; height:48px; object-fit:cover; border-radius:6px;">
                    {% endif %}
                </td>
                <td>{{ producto.nombre }}</td>
                <td>${{ producto.precio_unitario }}</td>
                <td>{{ producto.cantidad_stock }}</td>
                <td>{{ producto.categoria.nombre if producto.categoria else '' }}</td>
                <td>
                    <a href="{{ url_for('editar_producto', producto_id=producto.id_producto) }}" class="action-btn" title="Editar"><i class="fas fa-edit"></i></a>
                    <form method="post" action="{{ url_for('eliminar_producto') }}" style="display:inline;">
                        <input type="hidden" name="id_producto" value="{{ producto.id_producto }}">
                        <button type="submit" class="action-btn" title="Eliminar" onclick="return confirm('¿Seguro que deseas eliminar este producto?');"><i class="fas fa-trash-alt"></i></button>
                    </form>
                    {% if producto.imagen_url %}
                    <form method="post" action="{{ url_for('eliminar_imagen_producto') }}" style="display:inline; margin-left:6px;">
                        <input type="hidden" name="id_producto" value="{{ producto.id_producto }}">
                        <button type="submit" class="action-btn" title="Eliminar imagen" onclick="return confirm('¿Eliminar imagen de este producto?');"><i class="fas fa-image-slash"></i></button>
                    </form>
                    {% endif %}
            </tr>
            {% else %}
            <tr>
                <td colspan="7" style="text-align:center; color:var(--accent-color);">
                    {% if q %}
                        No se encontraron productos que coincidan con "{{ q }}".
                    {% else %}
                        No hay productos registrados.
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    {% if pagination %}
    <div class="pagination" style="margin-top:14px; display:flex; gap:8px; align-items:center;">
        {% if pagination.has_prev %}
            <a href="?page={{ pagination.prev_num }}&per_page={{ per_page }}{% if q %}&q={{ q }}{% endif %}{% if id_categoria %}&id_categoria={{ id_categoria }}{% endif %}{% if min_price %}&min_price={{ min_price }}{% endif %}{% if max_price %}&max_price={{ max_price }}{% endif %}">&laquo; Anterior</a>
        {% else %}
            <span style="opacity:0.5">&laquo; Anterior</span>
        {% endif %}
        <span>Página {{ pagination.page }} de {{ pagination.pages }} ({{ total }} resultados)</span>
        {% if pagination.has_next %}
            <a href="?page={{ pagination.next_num }}&per_page={{ per_page }}{% if q %}&q={{ q }}{% endif %}{% if id_categoria %}&id_categoria={{ id_categoria }}{% endif %}{% if min_price %}&min_price={{ min_price }}{% endif %}{% if max_price %}&max_price={{ max_price }}{% endif %}">Siguiente &raquo;</a>
        {% else %}
            <span style="opacity:0.5">Siguiente &raquo;</span>
        {% endif %}
    </div>
    {% endif %}

    <script>
    // Autocomplete básico: consulta al endpoint y rellena el datalist
    (function(){
        const qInput = document.getElementById('q-input');
        const dataList = document.getElementById('autocomplete-list');
        let timer = null;
        qInput.addEventListener('input', function(){
            const v = this.value.trim();
            if(timer) clearTimeout(timer);
            if(!v) { dataList.innerHTML = ''; return; }
            timer = setTimeout(()=>{
                fetch(`/admin/productos/autocomplete?q=${encodeURIComponent(v)}`)
                    .then(r=>r.json())
                    .then(items=>{
                        dataList.innerHTML = '';
                        items.forEach(it=>{
                            const opt = document.createElement('option');
                            opt.value = it.nombre;
                            dataList.appendChild(opt);
                        });
                    }).catch(()=>{});
            }, 200);
        });
    })();
    </script>
</div>
{% endblock %}
